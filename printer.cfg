# 此文件包含章鱼主板的常见引脚映射。要使用此配置，应使用“32KiB bootloader”为 STM32F446 编译固件启用“extra low-level configuration options”并选择“12MHz crystal”作为时钟参考。
# 此文件由《粉兔3D打印机》提供，欢迎联系QQ：670223677.
# 运行“make”后，将生成的“klipper/out/klipper.bin”文件复制到一个 SD 卡上名为“firmware.bin”的文件，然后使用该 SD 卡重新启动 章鱼主板。
# 注意主板硬件配置章鱼主板 TMC2209 UART 配置 。
#####################################################################
#####################################################################
##***需要更改/检查的事项：***
## MCU 路径                               [mcu]  # 主板序列号（通过"ls -l /dev/serial/by-id/"获取主板序列号）
## 热敏电阻类型	                           [extruder] 和 [heater_bed]-请参阅文件末尾的“传感器类型”列表 
## Z轴限位开关停止位置                      [safe_z_home] 
## 归位结束位置                            [gcode_macro G32] 
## Z轴限位开关偏移位置                      [stepper_z] 
## 探测点                                 [quad_gantry_level] 
## 最小和最大位置                          [quad_gantry_level] 
## PID 调节	                              [extruder] and [heater_bed] 
## 微调挤出机电机步进值                     [extruder] 
#####################################################################
#####################################################################
## 	热敏电阻（温度传感器）类型
##   "EPCOS 100K B57560G104F"
##   "ATC Semitec 104GT-2"
##   "NTC 100K beta 3950"
##   "Honeywell 100K 135-104LAG-J01"
##   "NTC 100K MGB18-104F39050L32" (Keenovo Heater Pad)
##   "AD595"
##   "PT100 INA826"

# Virtual SD Card
[virtual_sdcard]
path: ~/gcode_files

# Pause/Resume Functionality
[pause_resume]

[display_status]

[force_move]
enable_force_move: True

##***需要更改/检查的事项：***
## MCU 路径                                [mcu] 
## 热敏电阻类型	                           [extruder] 和 [heater_bed]-请参阅文件末尾的“传感器类型”列表
## Z轴限位开关停止位置                      [safe_z_home] 
## 归位结束位置                            [gcode_macro G32] 
## Z轴限位开关偏移位置                      [stepper_z] 
## 探测点                                 [quad_gantry_level] 
## 最小和最大位置                          [quad_gantry_level] 
## PID 调节	                              [extruder] and [heater_bed] 
## 微调挤出机电机步进值                     [extruder] 

#####################################################################
# 	                          主板配置
#####################################################################
[mcu] # 章鱼主板序列号（通过"ls -l /dev/serial/by-id/"获取主板序列号）
#baud: 250000
#serial: /dev/btt-octopus-pro-446
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_hyy-if00
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_btt-octopus-pro-446-if00
# serial: /dev/btt-octopus-pro-446
baud: 250000
serial: /dev/fysetc-spider
#--------------------------------------------------------------------
# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

# not all aliases are set yet, but diag pins my be usefull in future (i.e detecting skipped steps on extruder)
[board_pins fysetc_spider_tmc2209]
aliases:
# steppers
  x_step_pin=PE11,   x_dir_pin=PE10,   x_enable_pin=PE9,   x_uart_pin=PE7,   x_diag_pin=null,   x_endstop_pin=PB14, # top-left stepper
  y_step_pin=PD8,   y_dir_pin=PB12,   y_enable_pin=PD9,   y_uart_pin=PE15,   y_diag_pin=null,   y_endstop_pin=PB13, # top-right stepper
  z0_step_pin=PE1,  z0_dir_pin=PE0,  z0_enable_pin=PC5,  z0_uart_pin=PD11,  z0_diag_pin=null, # front-left stepper
  z1_step_pin=PD12,  z1_dir_pin=PC4,  z1_enable_pin=PE8,  z1_uart_pin=PA15,  z1_diag_pin=null, # middle-back stepper
  z2_step_pin=PE2,  z2_dir_pin=PE4,  z2_enable_pin=PE3,  z2_uart_pin=PC15,  z2_diag_pin=null, # front-right stepper
  e_step_pin=PD5,   e_dir_pin=PD6,   e_enable_pin=PD4,   e_uart_pin=PD7,   e_diag_pin=null,   e_heater_pin=PB15,  e_sensor_pin=PC0,
# accel
  adxl345_cs_pin=PA4,
# auto leveling
  bltouch_sensor_pin=PA0,  bltouch_control_pin=PA2,
  probe_pin=PA3,
# fans
  fan_part_cooling_pin=PB1,
  fan_toolhead_cooling_pin=PB0,
  fan_controller_board_pin=PB2,
# Bed heater
  heater_bed_heating_pin=PB4,
  heater_bed_sensor_pin=PC3,

## Expansion ports
  # taken from https://github.com/KevinOConnor/klipper/blob/master/config/generic-fysetc-spider.cfg
  # labeled as EXP2 header on v1.0
  EXP1_10=<5V>, EXP1_9=<GND>,
  EXP1_8=PD1,   EXP1_7=PD0,
  EXP1_6=PC12,  EXP1_5=PC10,     # Slot in the socket on the other side
  EXP1_4=PD2,   EXP1_3=PC11,
  EXP1_2=PA8,   EXP1_1=PC9,

  # labeled as EXP1 header on v1.0
  EXP2_10=<5V>, EXP2_9=<GND>,
  EXP2_8=<RST>, EXP2_7=PB10,
  EXP2_6=PA7,   EXP2_5=PC7,       # Slot in the socket on the other side
  EXP2_4=PA4,   EXP2_3=PC6,
  EXP2_2=PA5,   EXP2_1=PA6  
  # also exposes spi1

#--------------------------------------------------------------------
#####################################################################
#                       树莓派主机配置
#####################################################################
#配置以下树莓派主板ID在配置ADXL345加速度计时需要启用，（把以下代码最前面#号删除即可）
# [mcu rpi]     # 树莓派主板ID配置
# serial: /tmp/klipper_host_mcu

#####################################################################
#                       adxl345加速度计配置（需要时启用即可）
#####################################################################
# [adxl345]  #          adxl345加速度计配置
# spi_bus: spi3
# cs_pin: adxl345_cs_pin

[adxl345]
cs_pin: adxl345_cs_pin
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
spi_software_sclk_pin: PA5

# [resonance_tester]
# accel_chip: adxl345              # 加速度芯片型号
# probe_points:150,150,40          # 这个地方建议配置成热床的中间

#####################################################################
#                             温度监控
#####################################################################
[temperature_sensor fysetc_spider_tmc2209] # 章鱼主板温度
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]  # 树莓派温度
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#[temperature_sensor Box]              # 箱内温度（需要增加一颗温感）
#sensor_type: NTC 100K beta 3950
#sensor_pin: PF5                       # 修改对应PIN（必填）
#min_temp: 10
#max_temp: 100

#####################################################################
#                            机型和加速度
#####################################################################
[printer]
kinematics: corexy           # 打印机类型：corexy
max_velocity: 300            # 最大速度（最大 300）#最大速度max_velocity: 300 、1000
max_accel: 3000              # 最大加速度（最大 4000） #最大加速度max_accel: 1500  、3000
max_accel_to_decel: 3000     # 最大加速至减速（最大 4000）# 最大加速至减速（最大 3000）max_accel_to_decel: 750 、3000
max_z_velocity: 15           # Z轴最大速度 #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350             # Z轴最大加速度 #最大加速度 max_z_accel: 20
square_corner_velocity: 5.0  # 方形拐角速度 #直角速度 
#####################################################################
# 	                         热床网格校准
#####################################################################
[bed_mesh]
speed: 80                    # 校准速度
horizontal_move_z: 18        # Z轴运动速度
mesh_min: 20,20              # 最小校准点坐标x，y
mesh_max: 465, 460           # 最大校准点坐标x，y
probe_count: 5,5             # 采样点数（4X4为16点）
mesh_pps: 2,2                # 补充采样点数
algorithm: bicubic           # 算法模型
bicubic_tension: 0.2         # 算法插值不要动
relative_reference_index: 7  # 第多少个点作为±0.00  （最好将点位设置在热床中间或者较平处）（解决热床校准之后在空中的问题）
fade_start: 1.0
fade_end: 10.0


#####################################################################
#                X 轴步进电机 on MOTOR0(B Motor)
#如果抖动的话可能是电机的接线有问题导致的。
#####################################################################
[stepper_x]                   ## X 轴步进电机 on MOTOR0(B Motor)
step_pin: x_step_pin          # X轴电机脉冲引脚 PF13 
dir_pin: x_dir_pin            # 方向设置 !PF12 
enable_pin: !x_enable_pin     # 使能引脚 !PF14  
rotation_distance: 40         # 主动轮周长mm (2GT-20T为 40mm  16T为 32mm)
microsteps: 32                # 细分 voron 32
full_steps_per_rotation:200   # 单圈脉冲数-对于0.9度步进设置为400
endstop_pin: x_endstop_pin    # 限位开关接口 PG6
position_min: 0               # 软限位最小行程
position_endstop: 0           # 软限位最大行程 (250mm-300mm-350mm)
position_max: 500             # 机械限位最大行程 (250mm-300mm-350mm)
homing_speed: 50              # 复位速度-最大 100
homing_retract_dist: 1        # 后撤距离 0
# homing_positive_dir: true     # 复位方向
#--------------------------------------------------------------------
[tmc2209 stepper_x]           # X轴步进电机驱动设置
uart_pin: x_uart_pin          # 驱动通信端口
# interpolate: true             # 微步插值256
run_current:1.1              # 运行电流mA voron 0.7ma
hold_current: 1          # 保持电流mA vorom 1ma
sense_resistor: 0.110         # 驱动采样电阻不要改
stealthchop_threshold: 200    # 静音阀值 200s

#####################################################################
#                  Y 轴步进电机 on MOTOR1 (A Motor)
#####################################################################
[stepper_y]
step_pin: y_step_pin         # Y轴电机脉冲引脚
dir_pin: y_dir_pin            # 方向设置
enable_pin: !y_enable_pin     # 使能引脚
rotation_distance: 40         # 主动轮周长mm （2GT-20T为 40mm  16T为 32mm）
microsteps: 32                # 细分
full_steps_per_rotation:200   # 单圈脉冲数-对于0.9度步进设置为400
endstop_pin: y_endstop_pin    # 限位开关接口
position_min: 0               # 软限位最小行程
position_endstop: 500         # 软限位最大行程 (250mm-300mm-350mm)
position_max: 500             # 机械限位最大行程 (250mm-300mm-350mm)
homing_speed: 50              # 复位速度-最大 100
homing_retract_dist: 5        # 后撤距离
homing_positive_dir: true     # 复位方向
#--------------------------------------------------------------------
[tmc2209 stepper_y]           # Y轴步进电机驱动设置
uart_pin: y_uart_pin                # 驱动通信端口
# interpolate: true             # 微步插值256
run_current: 1.1              # 运行电流mA
hold_current:1              # 保持电流mA
sense_resistor: 0.110         # 驱动采样电阻不要改
stealthchop_threshold: 200    # 静音阀值
 
#####################################################################
#               Z0 步进电机 - 左前 on MOTOR2_1
#####################################################################
[stepper_z]                   # Z0 步进电机 - 左前 on MOTOR2_1
step_pin: z0_step_pin         # Z电机脉冲引脚
dir_pin:  !z0_dir_pin         # 方向设置
enable_pin: !z0_enable_pin    # 使能引脚
rotation_distance: 4         # 主动轮周长mm （2GT-20T为 40mm  16T为 32mm）
#gear_ratio: 80:16             # 减速比
microsteps: 64                # 细分
#--------------------------------------------------------------------
endstop_pin: probe:z_virtual_endstop      # 限位开关接口
position_max:470             # 软限位最大行程 (240mm-290mm-340mm)
position_min: -12           # 软限位最小行程（配置喷嘴清洁需要-5左右）
homing_speed: 10              # 复位速度-最大 20
second_homing_speed: 3        # 二次复位速度-最大 10
homing_retract_dist: 0        # 后撤距离
#--------------------------------------------------------------------
[tmc2209 stepper_z]
uart_pin: z0_uart_pin         # 驱动通信端口
interpolate: true             # 微步插值256
run_current: 0.8              # 运行电流mA
hold_current: 0.4           # 保持电流mA
sense_resistor: 0.110         # 驱动采样电阻不要改
stealthchop_threshold: 1    # 静音阀值

#####################################################################
#               Z1 步进电机 - 左前 on MOTOR2_1
#####################################################################
[stepper_z1]                   # Z1 步进电机 - 左后 on MOTOR3
step_pin: z1_step_pin          # Z1电机脉冲引脚
dir_pin:  !z1_dir_pin          # 方向设置
enable_pin: !z1_enable_pin     # 使能引脚
rotation_distance: 4           # 主动轮周长mm （2GT-20T为 40mm  16T为 32mm）
#gear_ratio: 80:16              # 减速比
microsteps: 64                # 细分
#--------------------------------------------------------------------
[tmc2209 stepper_z1]
uart_pin: z1_uart_pin         # 驱动通信端口
interpolate: true             # 微步插值256
run_current: 0.8              # 运行电流mA
hold_current: 0.4           # 保持电流mA
sense_resistor: 0.110         # 驱动采样电阻不要改
stealthchop_threshold: 1    # 静音阀值

#####################################################################
#               Z2 步进电机 - 左后 on MOTOR3
#####################################################################
[stepper_z2]                  # Z2 步进电机 - 左后 on MOTOR3
step_pin: z2_step_pin         # Z2电机脉冲引脚
dir_pin: !z2_dir_pin          # 方向设置
enable_pin: !z2_enable_pin    # 使能引脚
rotation_distance: 4          # 主动轮周长mm （2GT-20T为 40mm  16T为 32mm）
#gear_ratio: 80:16             # 减速比
microsteps: 64                # 细分
#--------------------------------------------------------------------
[tmc2209 stepper_z2]          # Z2轴步进电机驱动设置
uart_pin: z2_uart_pin         # 驱动通信端口
interpolate: true             # 微步插值256
run_current: 0.8              # 运行电流mA
hold_current: 0.4           # 保持电流mA
sense_resistor: 0.110         # 驱动采样电阻不要改
stealthchop_threshold: 1    # 静音阀值

#####################################################################
#                        E0 挤出机配置
#####################################################################
#	E0 挤出机电机 on MOTOR6
[extruder]
step_pin: e_step_pin          # E0电机脉冲引脚
dir_pin: !e_dir_pin           # 方向设置
enable_pin: !e_enable_pin     # 使能引脚
# 校准步进值: 23.1325301 = 旧值22.6789511*（实际值102/目标值100）
rotation_distance: 19.74 # 步进值-Bondtech 5mm 驱动齿轮 rotation_distance: 4.63
# 传动比    (M4、3.1为 80:20 , BMG 为 50:17)
gear_ratio: 50:17           # BMG 传动比
microsteps: 32                # 细分
full_steps_per_rotation: 100  # 单圈脉冲数 （200 为 1.8 度, 400 为 0.9 度）
nozzle_diameter: 0.400        # 喷嘴直径
filament_diameter: 1.75       # 耗材直径
heater_pin: e_heater_pin      #加热棒pin
max_extrude_only_velocity: 60
max_extrude_only_distance:100.1   #增加自动挤出的距离
#--------------------------------------------------------------------
 #传感器型号  (NTC 100K beta 3950,ATC Semitec 104GT-2, One of "MAX6675", "MAX31855", "MAX31856", or "MAX31865".)
# sensor_type: NTC 100K beta 3950
# sensor_pin:e_sensor_pin
sensor_type: MAX31865
sensor_pin: PD7 # I pulg into Spider E4-MOT socket, `cs` pin is the sensor pin
spi_speed: 4000000
spi_software_sclk_pin: PE12
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2 # Edit it according to the wires count of your PT100 sensor, like `3` or `4`.
rtd_use_50Hz_filter: True
#--------------------------------------------------------------------
min_temp: -273               # 最小温度
max_temp: 900                # 最大温度
max_power: 1.0                # 最大功率
min_extrude_temp: 170         # 最小挤出温度
#喷嘴温度PID校准命令：  "PID_CALIBRATE HEATER=extruder TARGET=245"
control = pid                # PID喷嘴温度自动校准项（默认被注释）
pid_kp = 21.442              # PID喷嘴温度自动校准项（默认被注释）
pid_ki = 1.191               # PID喷嘴温度自动校准项（默认被注释）
pid_kd = 96.490           # PID喷嘴温度自动校准项（默认被注释）
pressure_advance: 0.05        # 推进压力-尽量将压力保持在1.0以下
pressure_advance_smooth_time: 0.040    # 平稳推进时间-默认值为0.040
#
[firmware_retraction]
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 60
retract_length: 0.5

#####################################################################
#                        E1 挤出机配置
#####################################################################
#--------------------------------------------------------------------
#E1 挤出机电机2 on MOTOR7-额外的远程挤出机（双挤出机）
#[extruder_stepper my_extra_stepper]
#extruder = extruder           # 同步到近程挤出机
#step_pin: PE6                 # E1电机脉冲引脚
#dir_pin: PA14                 # 方向设置
#enable_pin: !PE0              # 使能引脚
#microsteps: 32                # 细分
## 校准步进值: 23.1325301 = 旧值22.6789511*（实际值102/目标值100）
#rotation_distance: 22.6789511 # 步进值-Bondtech 5mm 驱动齿轮
## 传动比    (M4 为 80:20 , BMG 为 50:17)
#gear_ratio: 50:17             # BMG传动比
#full_steps_per_rotation: 200  # 单圈脉冲数 （200 为 1.8 度, 400 为 0.9 度）
##shared_heater: extruder      # 共用热端（双挤出默认不开启）
##nozzle_diameter: 0.400       # 喷嘴直径（双挤出默认不开启）
##filament_diameter: 1.75      # 耗材直径（双挤出默认不开启）
#[tmc2209 extruder_stepper my_extra_stepper]
#uart_pin: PD3                 # 驱动通信端口
#interpolate: True             # 微步插值256
#run_current: 0.6              # 运行电流mA
#hold_current: 0.6             # 保持电流mA
#sense_resistor: 0.110         # 驱动采样电阻不要改
#stealthchop_threshold: 999999 # 静音阀值
#--------------------------------------------------------------------
[verify_heater extruder]      # 加热块温度容差配置
max_error: 120                # 最大误差
check_gain_time:120           # 容差时间
hysteresis: 50                # 容差温度
heating_gain: 2               # 加热增益

#####################################################################
#                            断料检测
#####################################################################
[filament_switch_sensor DLJC]
# 当设置为True时，将在断料后立即执行暂停。请注意，如果pause_on_runout为False，将在断料后不执行，然后断料检测被禁用。默认是True。
pause_on_runout: True
# 断料后要执行的 G 代码命令，如果pause_on_runout设置为 True 此 G 代码将在PAUSE 完成。默认不运行任何 G 代码命令。
runout_gcode:
# 插入耗材丝后要执行的 G 代码命令，这默认是不运行任何 G-Code 命令，这会禁用插入检测。
insert_gcode:
# 事件之间延迟的最短时间（以秒为单位）。在此时间段内触发的事件将被静默忽略。 默认值为 3 秒。
event_delay: 3.0
# 暂停命令之间的延迟时间，以秒为单位调度和执行 runout_gcode。 如果出现奇怪的暂停行为，则增加此延迟。默认为 0.5 秒。
pause_delay: 0.5
# 设置引脚，这个参数必须填
switch_pin:PG10

#####################################################################
#                            热床配置
#####################################################################
[heater_bed]
heater_pin: heater_bed_heating_pin                     # 热床接口
sensor_type: Generic 3950                              # 热床传感器类型
sensor_pin: heater_bed_sensor_pin                      # 热床传感器接口
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 0.9                       # 热床功率
min_temp: 0                          # 最小温度（注意：测量温度超过设定值会触发紧急停止）
max_temp: 120                        # 最大温度（注意：测量温度超过设定值会触发紧急停止）
pwm_cycle_time: 0.02 # 50hz for european AC, to avoid flickering lights.
# 热床温度PID校准命令：  "PID_CALIBRATE HEATER=heater_bed TARGET=100"
control: pid                # PID热床温度自动校准项（默认被注释）
pid_kp: 58.437              # PID热床温度自动校准项（默认被注释）
pid_ki: 2.347               # PID热床温度自动校准项（默认被注释）
pid_kd: 363.769             # PID热床温度自动校准项（默认被注释）

#####################################################################
#                           PL08N感应探头
#####################################################################
# PL08N感应探头不低于喷嘴高度，仅用于调平,如果你的PL08N是NO（常开），请将更改pin添加到！PG11
# [probe]                              #调平感应探头
# pin: ~!PG11                          # 信号接口
# x_offset: 0                          # X轴-传感器相对喷嘴偏移量
# y_offset: 25.0                       # Y轴-传感器相对喷嘴偏移量
# z_offset: 2.50                       # Z轴-传感器相对喷嘴偏移量
# speed: 4.0                           # 调平速度
# samples: 3                           # 采样次数
# samples_result: median               # 取值方式（默认median-中位数）
# sample_retract_dist: 3.0             # 调平回缩距离
# samples_tolerance: 0.02              # 采样公差（注意过小的值可能造成采样次数增加）
# samples_tolerance_retries: 5         # 超公差重试次数

#pin: ^probe_pin # For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!probe_pin # NPN NO (refer to the specs on your probe)
#pin: probe_pin # PNP NO (refer to the specs on your probe)
#pin: !probe_pin # PNP NC (refer to the specs on your probe)

#offsets :
# 8mm:
#   Hemera: X31.48, Y-41.69
#   Aero: X-50.35, Y8 or X-14, Y-44.9
#   Others: X-27.8, Y-12
# 12mm:
#    Hemera: X32.98, Y-43.69
#    Aero: X-52.35, Y6.5 or X-12.5, Y-46.9
#    Others: X-29.8, Y-13.5
# 18mm:
#    Hemera: X36.98, Y-46.69
#    Aero: X-55.35, Y2.5 or X-8.5, Y-49.9
#    Others: X-32.8, Y-17.5


#####################################################################
# 	                        Bltouch感应探头
#####################################################################
[bltouch]
sensor_pin: ^bltouch_sensor_pin
control_pin: bltouch_control_pin
speed: 7
pin_move_time: 0.69
sample_retract_dist: 10
pin_up_reports_not_triggered: True
pin_up_touch_mode_reports_triggered: True
x_offset: -28
y_offset: -13
# offsets for the standard BLtouch probe:
# x -28 y -13
# offsets for the alternate probe:
# x -33.5 y -5
# offsets are the same for V6, Dragon, Mosquito
#z_offset: 0.01
# Adjust this to fit your setup
# Inductive/Capacitive probe

#####################################################################
#                             风扇配置
#####################################################################
[fan]                                # 模型冷却风扇
pin: fan_part_cooling_pin            # 信号接口
kick_start_time: 0.5                 # 启动时间（勿动）
off_below: 0.10                      # 勿动
shutdown_speed: 1.0
#--------------------------------------------------------------------
[heater_fan toolhead_cooling_fan]     # 喉管冷却风扇
pin: fan_toolhead_cooling_pin         # 信号接口
max_power: 1.0                        # 最大转速
kick_start_time: 0.5                  # 启动时间（勿动）
heater: extruder             # 关联的设备：挤出机
heater_temp: 50              # 挤出机达到多少度启动风扇
#fan_speed: 1.0              # 风扇转速
# #--------------------------------------------------------------------
# [heater_fan controller_fan]  # 侧边风扇1
# pin: PD12                    # 信号接口
# max_power: 1.0               # 最大转速
# kick_start_time: 0.5         # 启动时间（勿动）
# heater: heater_bed           # 关联的设备：热床
# heater_temp: 20              # 热床达到多少度启动风扇
# #--------------------------------------------------------------------
# [heater_fan controller_fan2] # 侧边风扇2
# pin: PD14                    # 信号接口
# max_power: 1.0               # 最大转速
# kick_start_time: 0.5         # 启动时间（勿动）
# heater: heater_bed           # 关联的设备：热床
# heater_temp: 20              # 热床达到多少度启动风扇
# #--------------------------------------------------------------------
# [heater_fan exhaust_fan]     # 排风扇
# pin: PD13                    # 信号接口
# max_power: 1.0               # 最大转速
# shutdown_speed: 0.0          # 关闭速度（勿动）
# kick_start_time: 5.0         # 开启时间（勿动）
# heater: heater_bed           # 关联的设备：热床
# heater_temp: 60              # 热床达到多少度启动风扇
# fan_speed: 1.0               # 风扇转速
#--------------------------------------------------------------------
[controller_fan controller_fan]  #主板散热风扇
pin: fan_controller_board_pin

#####################################################################
#                            LED灯带配置（需要时启用）
#####################################################################
#[neopixel LEDlight]
#pin: PB0                     # 信号接口
#chain_count: 26              # 灯珠数量
#color_order: GRB             # 颜色顺序
#initial_RED: 0.2             # 初始  红色  量
#initial_GREEN: 0.2           # 初始  绿色  量
#initial_BLUE: 0.2            # 初始  蓝色  量
#--------------------------------------------------------------------
#[output_pin caselight]
# Chamber Lighting - Bed Connector (Optional)
#pin: P2.5
#pwm:true
#shutdown_value: 0
#value:100
#cycle_time: 0.01
#--------------------------------------------------------------------
[output_pin LED]                     #灯光输出
pin: PD13

#####################################################################
#                  必趣12864mini点阵屏引脚配置（勿动）
#####################################################################
# [board_pins]
# aliases:
#     # EXP1 header
#     EXP1_1=PE8, EXP1_2=PE7,
#     EXP1_3=PE9, EXP1_4=PE10,
#     EXP1_5=PE12, EXP1_6=PE13,
#     EXP1_7=PE14, EXP1_8=PE15,
#     EXP1_9=<GND>, EXP1_10=<5V>,

#     # EXP2 header
#     EXP2_1=PA6, EXP2_2=PA5,
#     EXP2_3=PB1, EXP2_4=PA4,
#     EXP2_5=PB2, EXP2_6=PA7,
#     EXP2_7=PC15, EXP2_8=<RST>,
#     EXP2_9=<GND>, EXP2_10=<5V>
# #--------------------------------------------------------------------
# [display]                    # 必趣 12864 mini
# lcd_type: uc1701
# cs_pin: EXP1_3
# a0_pin: EXP1_4
# rst_pin: EXP1_5
# encoder_pins: ^EXP2_5, ^EXP2_3
# click_pin: ^!EXP1_2
# contrast: 63
# spi_software_miso_pin: EXP2_1
# spi_software_mosi_pin: EXP2_6
# spi_software_sclk_pin: EXP2_2
# #--------------------------------------------------------------------
# [neopixel btt_mini12864]     # 必趣 12864 mini-RGB灯配置
# pin: EXP1_6
# chain_count: 3
# # RGB 颜色配置
# color_order: RGB             # 颜色顺序
# initial_RED: 0.5             # 初始  红色  量
# initial_GREEN: 0.5           # 初始  绿色  量
# initial_BLUE: 0.5            # 初始  蓝色  量

#####################################################################
#                          闲置关闭热床
#####################################################################
[idle_timeout]
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      M117 Idle timeout reached
      TURN_OFF_HEATERS
    {% endif %}
  {% endif %}
timeout: 1800                # 空闲时间超过30分钟则关闭热床
#####################################################################
#                        归位和龙门调整程序
#####################################################################
# 以下两种设置Z轴限位位置方式选择一种，把另一种注释掉即可，
#[homing_override]
#axes: z
#set_position_z: 0
#gcode:
#   G90
#   G0 Z15 F600
#   G28 X Y
#    ## Z 限位开关的 XY 位置
#    ##通过后将X0和Y0更新为你的值（如X157、Y305）
#    ## Z 轴限位位置定义
#   G0 X185 Y250 F3600    #250mm   
#   G28 Z
#   G0 Z10 F1800
#--------------------------------------------------------------------
[safe_z_home]                # Z轴限位坐标
# home_xy_position:150,150     # Z轴限位位置定义（重要！！！自行进行调整）
#home_xy_position: 200,200 # 400mm printer
home_xy_position: 250,250 # 500mm printer
speed:100                    # 归位速度
z_hop:5                     # 归位之后抬升高度

#--------------------------------------------------------------------
[z_tilt]       #[quad_gantry_level]          # 300mm机器调平参数
#gantry_corners:
#	-60,-10
#	310,320
#points:                      # 250mm机器调平点位
#	50,25
#	50,175
#	200,175
#	200,25
#--------------------------------------------------------------------
# gantry_corners:              # 300mm机器调平点位
# 	-60,-10
# 	360,370
# points:
# 	50,25
# 	50,225
# 	250,225
# 	250,25
#--------------------------------------------------------------------
z_positions:
	0,0
	250,500
	500,0
points:
	# 60,60
	# 185,270
	# 260,60
	60,60
	285,470
	460,60
		
#--------------------------------------------------------------------
#gantry_corners:              # 350mm机器调平点位
#	-60,-10
#	410,420
#points:
#	50,25
#	50,275
#	300,275
#	300,25
#--------------------------------------------------------------------
speed: 90                    # 调平速度
horizontal_move_z: 22        # Z轴起始高度12
retry_tolerance: 0.05      # 采样公差 #需要修改的是 平均精度。
retries: 10                   # 超公差重试次数 10
# max_adjust: 5               # 调平最大调整行程

#--------------------------------------------------------------------

#####################################################################
#                           宏配置选项
#####################################################################

### MACRO CONFIGURATION
[gcode_macro RatOS]
# 使用绝对挤压模式
# 设置为 True 使用相对挤压模式
variable_relative_extrusion: False
# 等待挤出机达到 150，以便感应探头（如果存在）处于可预测的温度。
# 还可以让床的热量稍微扩散，并软化可能粘在喷嘴上的任何塑料。
# 设置为 False 以禁用
variable_preheat_extruder: True
# 在 START_PRINT 宏中校准床网格。
# 设置为 false 跳过 BED_MESH_CALIBRATE，它仍然会加载 BED_MESH
# 使用名称“ratos”，请务必使用该名称保存您的 Bed_mesh 配置文件。
# 或覆盖 _START_PRINT_BED_MESH 宏以实现您自己的网格处理逻辑。
variable_calibrate_bed_mesh: True
# 在 START_PRINT 宏的末尾打印一个主要行
# 设置为 False 以禁用喷嘴启动。
variable_nozzle_priming: "primeline"
# 等待挤出机加热时停在后面
# 设置为“front”以停在前面，或“center”停在中间。
variable_start_print_park_in: "back"
# Height to park it when waiting for extruder to heat.
# 等待挤出机加热时停放的高度。
variable_start_print_park_z_height: 50
# 在开始打印前加载倾斜配置文件
# 取消注释以使用您的校准偏斜校正配置文件。
#variable_skew_profile: "my_skew_profile"
# 打印结束或取消后停在后面。
# 设置为“front”以停在前面，或“center”停在中间。
variable_end_print_park_in: "back"
# 打印暂停时停在后面。
# 设置为“front”以停在前面，或“center”停在中间。
variable_pause_print_park_in: "back"
# 以毫米/秒为单位设置 RatOS 宏中的移动速度。
variable_macro_travel_speed: 150


#####################################################################
#                           自定义gcode宏1
#####################################################################
[gcode_arcs]                       # 允许圆弧插补
resolution: 1.0                    # 启用圆弧插补G2，G3
#--------------------------------------------------------------------
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR                 # 卸载网床
    G28                            # 归位所有轴
    QUAD_GANTRY_LEVEL              # 龙门架调平
    G28                            # 归位所有轴
    #G0 X125 Y125 Z30 F3600         # 250mm
    G0 X150 Y150 Z30 F3600        # 300mm
    #G0 X175 Y175 Z30 F3600        # 350mm
#--------------------------------------------------------------------
[gcode_macro PRINT_START]          # 将 PRINT_START 设置为开始打印时的宏，自定义打印前的动作
gcode:
    G92 E0
    BED_MESH_CLEAR                 # 卸载网床
    G28                            # 归位所有轴
    QUAD_GANTRY_LEVEL              # 龙门架调平
    G28                            # 归位所有轴
    #NOZZLE_CLEAR                   # 喷嘴清洁
    #G28                            # 归位所有轴
    G1 Z20 F3000                   # 将喷嘴移离热床
    BED_MESH_PROFILE LOAD=default  # 加载网床
    #SET_LED LED=LEDlight RED=0.2 GREEN=0.2 BLUE=0.5   # LED灯控制
    #M117 Printing                  # 向屏幕发送文本
#--------------------------------------------------------------------
#[gcode_macro NOZZLE_CLEAR]         # 250mm机器 喷嘴清洁（需要自己修改坐标）
#gcode:
#    G91
#    G1 Z9 F1000
#    G90
#    G0 X80 Y250 F3600
#    G0 Z-0.3 F800
#    G0 X30 F5000
#    G0 X70 F5000
#    G0 X30 F5000
#    G0 X70 F5000
#    G0 X30 F5000
#    G0 Z5 F800
#--------------------------------------------------------------------
[gcode_macro PRINT_END]            # 将 PRINT_END 设置为打印结束时的宏，自定义打印完成之后动作
gcode:
    M400                           # 等待缓冲区清除
    G92 E0                         # 将挤出机归零
    G1 E-10.0 F3600                # 缩回耗材丝
    G91                            # 相对定位
    G0 Z1.00 X20.0 Y20.0 F6000    # 移动喷嘴以移除架线
    TURN_OFF_HEATERS               # 关闭热端
    M107                           # 关闭风扇
    G1 Z2 F3000                    # 将喷嘴向上移动2毫米
    G90                            # 绝对定位
    G0  X150 Y300 F3600            # 将喷嘴停在后部
    BED_MESH_CLEAR                 # 卸载网床
    #SET_LED LED=LEDlight RED=0.3 GREEN=0.8 BLUE=0.3   # LED灯控制
    #M117  Idle                     # 向屏幕发送文本
    #UPDATE_DELAYED_GCODE ID=powerOFF DURATION=600     # 延迟 600 秒关机(搭配以下打完关机配置，如无模块请注释掉或删除）

#####################################################################
#                           打完关机（需要时启用）
#####################################################################
#此打完关机配置 为 "必趣打完关机模块" 与 "章鱼主板"，如无模块请全部注释掉或者删除。
#使用本脚本后，在"Klipper首页-自定义宏"处出现"DWGJ_ON"与"DWGJ_OFF"
#打印前或者打印中点击 "DWGJ_ON"即开启，"DWGJ_OFF"即关闭
#[gcode_macro DWGJ_ON]       # 使能打完关机
#variable_dwgj_on: 0
#gcode:
#    SET_GCODE_VARIABLE MACRO=DWGJ_ON VARIABLE=dwgj_on VALUE=1
#    {action_respond_info("DWGJ-ON-ON-ON!")}
#    # 需要使用打完关机时只需点击Klipper首页的 "DWGJ_ON"按钮即开启打完关机
##--------------------------------------------------------------------
#[gcode_macro DWGJ_OFF]      # 失能打完关机
#gcode:
#    SET_GCODE_VARIABLE MACRO=DWGJ_ON VARIABLE=dwgj_on VALUE=0
#    {action_respond_info("DWGJ-OFF-OFF-OFF!")}
#    # 不需要使用打完关机时只需点击Klipper首页的 "DWGJ_OFF"按钮即关闭打完关机
##--------------------------------------------------------------------
#[gcode_macro M81]            # M81指令触发的同时打完关机变量使能才会执行关机
#gcode:
#    {% set is_shutdown = printer["gcode_macro DWGJ_ON"].dwgj_on|int %}
#    {% if is_shutdown == 1 %}
#        SHUT_DOWN
#    {% else %}
#    # 若为触发则暂时什么都不做
#    {% endif %}
##--------------------------------------------------------------------
#[gcode_macro SHUT_DOWN]      # 设置 SHUT_DOWN 为关机宏
#gcode:
#    SET_GCODE_VARIABLE MACRO=DWGJ_ON VARIABLE=dwgj_on VALUE=0 #失能打完关机
#     {action_emergency_stop("Ready to shut down!!!")}         #执行软件层面关机
#    UPDATE_DELAYED_GCODE ID=Delayed_SHUT_DOWN DURATION=3      #执行切断电源
##--------------------------------------------------------------------
#[output_pin killbutton]      # 打完关机模块引脚
#pin:PE11            # 打完关机引脚，必须填写
#value: 1            # 默认值
##shutdown_value: 0  # 关机值
##--------------------------------------------------------------------
#[delayed_gcode Delayed_SHUT_DOWN]  # 设置延迟关机宏
#gcode:
#    set_pin pin=killbutton value=0.0        # 延迟关机
##--------------------------------------------------------------------
#[delayed_gcode powerOFF]           # 设置延迟执行M81宏
#gcode:
#    M81 value=0.0                           # 延迟执行M81


####################################################################
#                         自定义gcode宏2 shell macros
#####################################################################
[gcode_shell_command generate_shaper_graph_x]
command: /home/pi/klipper_config/config/scripts/generate-shaper-graph-x.sh
timeout: 60.
verbose: True

[gcode_shell_command generate_shaper_graph_y]
command: /home/pi/klipper_config/config/scripts/generate-shaper-graph-y.sh
timeout: 60.
verbose: True

[gcode_shell_command compile_binaries]
command: /home/pi/klipper_config/config/scripts/compile-binaries.sh
timeout: 600.

[gcode_shell_command change_hostname]
command: /home/pi/klipper_config/config/scripts/change-hostname.sh
timeout: 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
gcode:
    {% if params.AXIS is defined %}
        {% if params.AXIS|lower == 'x' %}
            G28
            TEST_RESONANCES AXIS=X
            RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
            RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
        {% elif params.AXIS|lower == 'y' %}
            G28
            TEST_RESONANCES AXIS=Y
            RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
            RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
        {% else %}
            {action_raise_error("Unknown axis specified. Expected X or Y.")}
        {% endif %}
    {% else %}
        G28
        TEST_RESONANCES AXIS=X
        TEST_RESONANCES AXIS=Y
        RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
        RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
        RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
    {% endif %}

[gcode_macro COMPILE_FIRMARE]
gcode:
    RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
    RUN_SHELL_COMMAND CMD=compile_binaries
    RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
gcode:
    {% if params.HOSTNAME is not defined %}
        RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
        RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
    {% else %}
        RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
    {% endif %}

####################################################################
#                         自定义gcode宏3  macros
#####################################################################
# WARNING: DO NOT EDIT OR INCLUDE THIS FILE. THIS IS A TEMPLATE.
# To change your macros, check the root macros.cfg file.

#####
# CONFIGURATION VARIABLES
#####

[gcode_macro ECHO_RATOS_VARS]
gcode:
  {% for var, value in printer["gcode_macro RatOS"].items() %}
    {action_respond_info(var ~ ": " ~ value)}
  {% endfor %}
  
[gcode_macro RatOS]
# Configuration Defaults
# This is only here to make the config backwards compatible.
# Configuration should exclusively happen in printer.cfg.
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeline"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 150
gcode:
  ECHO_RATOS_VARS

#####
# GENERAL MACROS
#####

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_extrude: 1.5
gcode:
  SAVE_GCODE_STATE NAME=PAUSE_state
  # Define park positions 
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
  # Calculate safe Z position
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  PAUSE_BASE
  G91
  # Retract
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  # Move to park position
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    _PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 

[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  # Prime
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
    G90
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
  RESUME_BASE

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
  END_PRINT
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  #SDCARD_RESET_FILE
  CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
gcode:
  {% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
  # Absolute positioning
  G90 
  # Absolute extrusion
  M82
  M117 Priming nozzle...
  # Lift 5 mm
  G1 Z5 F3000
  # Move to prime area
  G1 X{printer.toolhead.axis_minimum.x + 5} Y{printer.toolhead.axis_minimum.y + 10} F{speed}
  # Get ready to prime
  G1 Z0.3 F3000
  # Reset extrusion distance
  G92 E0
  # Prime nozzle 
  G1 Y{printer.toolhead.axis_minimum.y + 80} E16 F1200
  # Wipe
  G1 Y{printer.toolhead.axis_minimum.y + 100} F{speed}
  # Reset extrusion
  G92 E0
  
[gcode_macro _PARK]
gcode:
  {% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
  # Get X position
  {% if params.X != '' %}
    {% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
      {% set safe_x = params.X|float %}
    {% else %}
      {action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
      {% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
    {% endif %}
  {% else %}
    {% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
  {% endif %}
  # Get Y position
  {% if params.LOCATION|default('back')|lower == 'back' %}
    {% set y = printer.toolhead.axis_maximum.y - 5 %}
  {% elif params.LOCATION|lower == 'front' %}
    {% set y = printer.toolhead.axis_minimum.y + 5 %}
  {% elif params.LOCATION|lower == 'center' %}
    {% set y = printer.toolhead.axis_maximum.y / 2 %}
  {% endif %}
  # Absolute positioning
  G90 
  # Park
  G0 X{safe_x} Y{y} F{speed} 

#####
# COLOR CHANGE
#####
[gcode_macro M600]
gcode:
  PAUSE
  UNLOAD_FILAMENT
  M117 Please load new filament and resume

#####
# FILAMENT MANAGEMENT
#####

[gcode_macro UNLOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=unload_state
  G91
  {% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
    M117 Heating...
    # Heat up hotend to provided temp or 220 as default as that should work OK with most filaments.
    M104 S{params.TEMP|default(220, true)}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
  {% endif %}
  M117 Unloading filament...
  # Extract filament to cold end area 
  G0 E-5 F3600
  # Wait for three seconds
  G4 P3000
  # Push back the filament to smash any stringing 
  G0 E20 F3600   #调整 E的长度
  # Extract back fast in to the cold zone 
  G0 E-15 F3600
  # Continue extraction slowly, allow the filament time to cool solid before it reaches the gears       
  G0 E-130 F300
  M117 Filament unloaded!
  RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=load_state
  G91
  # Heat up hotend to provided temp or 220 as default as that should work OK with most filaments.
  {% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
    M117 Heating...
    M104 S{params.TEMP|default(220, true)}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
  {% endif %}
  M117 Loading filament...
  # Load the filament into the hotend area.
  G0 E100 F600
  # Wait a secod
  G4 P1000
  # Purge
  G0 E40 F100
  # Wait for purge to complete
  M400e
  M117 Filament loaded!
  RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
gcode:
  SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

#####
# START PRINT MACROS
# Call this from your slicer (custom g-code). 
# Read more here: https://rat-rig.github.io/V-CoreOS/#/slicers
#####

[gcode_macro START_PRINT]
gcode:
  CLEAR_PAUSE
  SAVE_GCODE_STATE NAME=start_print_state
  # Metric values
  G21
  # Absolute positioning
  G90 
  # Set extruder to absolute mode
  M82
  # Home 
  G28
  M117 Heating bed...
  # Wait for bed to heat up
  M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
  # Run the customizable "AFTER_HEATING_BED" macro.
  _START_PRINT_AFTER_HEATING_BED
  # Run the customizable "BED_MESH" macro
  _START_PRINT_BED_MESH
  # Start heating extruder
  M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
  # Run the customizable "PARK" macro
  _START_PRINT_PARK
  # Wait for extruder to heat up
  M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
  # Run the customizable "AFTER_HEATING_EXTRUDER" macro.
  _START_PRINT_AFTER_HEATING_EXTRUDER
  M117 Printing...
  RESTORE_GCODE_STATE NAME=start_print_state
  # Set extrusion mode based on user configuration
  {% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
    M83
  {% else %}
    M82
  {% endif %}
  G92 E0

#####
# START PRINT MACRO HOOKS
# You can copy these to printer.cfg and modify them to your liking, or just use them as is.
####

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode:
  {% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
    M117 Pre-heating extruder...
    # Wait for extruder to reach 150 so an inductive probe (if present) is at a predictable temp. 
    # Also allows the bed heat to spread a little, and softens any plastic that might be stuck to the nozzle.
    M104 S150
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
  {% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode:
  {% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
    BED_MESH_CALIBRATE PROFILE=ratos
  {% endif %}
  BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode:
  {% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
  _PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
  G0 Z{z} F6000

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode:
  {% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
    PRIME_LINE
  {% endif %}
  {% if printer["gcode_macro RatOS"].skew_profile is defined %}
    SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
  {% endif %}

#####
# END PRINT MACROS
# Call this from your slicer (custom g-code). 
# Read more here: https://rat-rig.github.io/V-CoreOS/#/slicers
#####

# The end_print macro is also called from CANCEL_PRINT.
[gcode_macro END_PRINT]
gcode:
  SAVE_GCODE_STATE NAME=end_print_state
  # Extruder heater off
  M104 S0
  # Bed heater off
  M140 S0
  _END_PRINT_AFTER_HEATERS_OFF
  _END_PRINT_PARK
  # Clear skew profile if any was loaded.
  {% if printer["gcode_macro RatOS"].skew_profile is defined %}
    SET_SKEW CLEAR=1
  {% endif %}
  # Steppers off
  M84
  # Part cooling fan off
  M107
  M117 Done.
  RESTORE_GCODE_STATE NAME=end_print_state

#####
# END PRINT MACRO HOOKS
# You can copy these to printer.cfg and modify them to your liking, or just use them as is.
####

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode:
  # Calculate safe Z position
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  # Relative positioning
  G91
  # Retract the filament a bit before lifting the nozzle.
  G1 E-2 F3600
  # Move to safe Z position
  G0 Z{z_safe} F3600
  # Retract filament even more
  G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode:
  _PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}



####################################################################
#                         自定义gcode宏4 内部宏
#####################################################################
[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode:
  {% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
  M117 Pre-heating extruder...
  # Wait for extruder to reach 150 so an inductive probe (if present) is at a predictable temp. 
  # Also allows the bed heat to spread a little, and softens any plastic that might be stuck to the nozzle.
  M104 S150
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
  {% endif %}
  M117 Adjusting for tilt...
  # Adjust bed tilt
  Z_TILT_ADJUST
  M117 Rehoming after tilt adjustment...
  # Home again as Z will have changed after tilt adjustment and bed heating.
  G28 Z


#####################################################################
#                     以下为脚本配置保存参数（勿动）
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
[bltouch]
z_offset =0.75#越大越贴近热床 间隙越小

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.202500, 0.021250, -0.077812, 0.004688, 0.208125
#*# 	  0.166875, 0.057187, 0.000000, 0.138125, 0.395625
#*# 	  0.066875, 0.076250, 0.074375, 0.261562, 0.561875
#*# 	  -0.031875, -0.004688, 0.090000, 0.346250, 0.569062
#*# 	  -0.233750, -0.067813, 0.157812, 0.403750, 0.710937
#*# tension = 0.2
#*# min_x = 20.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 5
#*# max_y = 460.0
#*# mesh_x_pps = 2
#*# max_x = 465.0
